# 자동한도조정 엔진 - 요구사항 정의서

> **Strategy Planner Deliverable**  
> **프로젝트**: NGUP 가입설계 자동한도조정  
> **문서 버전**: 1.0 | **작성일**: 2026-01-27

---

## 1. 개요

### 1.1 목적

가입설계 화면에서 "자동한도조정" 버튼 클릭 시, 주계약/특약/급부 간 복잡한 관계를 모두 고려하여 **현재 설정된 금액을 최대한 보존하면서 초과된 부분만 자동 조정**하는 기능을 제공한다.

### 1.2 시스템 범위

| 구분             | 범위                                                         |
| ---------------- | ------------------------------------------------------------ |
| **In-Scope**     | 급부 초과 감지, 자동 감액 조정, 가입단위 정합성, 결과 시각화 |
| **Out-of-Scope** | PRE 연동, 보험료 재계산, 청약 접수, 기간계 연동              |

---

## 2. 기능 요구사항

### FR-001: 급부 초과 감지

| 항목     | 내용                                                  |
| -------- | ----------------------------------------------------- |
| 설명     | 각 급부별 가입금액 합계가 캡을 초과하는지 실시간 감지 |
| 우선순위 | 🔴 필수                                               |
| 입력     | 특약 목록, 급부 목록, 급부별 캡                       |
| 출력     | 초과 급부 목록, 초과 금액 (**최대 위반 우선 정렬**)   |

### FR-002: 자동 감액 알고리즘 (Multi-Strategy)

| 항목      | 내용                                                                                          |
| --------- | --------------------------------------------------------------------------------------------- |
| 설명      | 초과된 급부에 대해 **3가지 전략 중 하나**를 선택하여 감액                                     |
| 우선순위  | 🔴 필수                                                                                       |
| 전략 1    | **비례 (Proportional)**: 비율 유지, 공평 분배 (기본값)                                        |
| 전략 2    | **Global Greedy (v1.4)**: 다중 위반($V$) 해결 및 효율($E$), 금액($A$) 최적화 + 고속 배치 처리 |
| 전략 3    | **역순 (LIFO)**: 나중에 추가된 특약 우선 절감                                                 |
| 자동 선택 | 실패 시 다른 전략 자동 시도 (Optional)                                                        |

### FR-008: 잠금 기능 (Locking)

| 항목     | 내용                                               |
| -------- | -------------------------------------------------- |
| 설명     | 사용자가 특정 특약을 감액 대상에서 제외하도록 설정 |
| 우선순위 | 🔴 필수                                            |
| UI       | 특약별 잠금(🔒) 아이콘 토글 제공                   |

### FR-003: 가입단위 정합성

| 항목     | 내용                           |
| -------- | ------------------------------ |
| 설명     | 감액 시 가입단위의 배수로 조정 |
| 우선순위 | 🔴 필수                        |
| 처리     | 감액량을 단위로 올림 계산      |

### FR-004: 최소값 보호

| 항목     | 내용                                           |
| -------- | ---------------------------------------------- |
| 설명     | 특약 금액이 최소값 이하로 감액되지 않도록 보호 |
| 우선순위 | 🔴 필수                                        |
| 경고     | 최소값 도달 시 경고 메시지 표시                |

### FR-005: 조정 결과 시각화 및 제어

| 항목     | 내용                                          |
| -------- | --------------------------------------------- |
| 설명     | 알고리즘 선택 및 조정 전/후 금액 비교         |
| 우선순위 | 🟡 권장                                       |
| UI       | **알고리즘 토글(비례/금액순/역순)** 버튼 제공 |
| UI       | 변경된 특약 하이라이트, ▼/▲ 화살표 표시       |

### FR-006: 급부 상태 표시

| 항목     | 내용                                        |
| -------- | ------------------------------------------- |
| 설명     | 각 급부의 캡 대비 사용률 프로그레스 바 표시 |
| 우선순위 | 🟡 권장                                     |
| 색상     | 정상(초록), 경고(노랑, 80%+), 초과(빨강)    |

### FR-007: 원복 기능

| 항목     | 내용                           |
| -------- | ------------------------------ |
| 설명     | 조정 전 원래 금액으로 되돌리기 |
| 우선순위 | 🟡 권장                        |

---

## 3. 비기능 요구사항

### NFR-001: 성능

| 항목      | 기준                              |
| --------- | --------------------------------- |
| 응답시간  | 특약 30개, 급부 50개 기준 < 100ms |
| 반복 제한 | 최대 100회 반복 후 수렴 실패 처리 |

### NFR-002: 호환성

| 항목     | 기준                           |
| -------- | ------------------------------ |
| 브라우저 | Chrome, Edge, Safari 최신 버전 |
| 반응형   | 1000px 이하에서 싱글 컬럼 전환 |

### NFR-003: 알고리즘 성능 (Performance)

| 항목 | 내용                                                                         |
| ---- | ---------------------------------------------------------------------------- |
| 설명 | 대규모 설계(특약 100개 이상) 및 복잡한 급부 연결 상황에서도 실시간 응답 보장 |
| 목표 | 감액 계산 1회 수행 시 **100ms 이내** 완료 (웹 시뮬레이터 기준)               |
| 구현 | 증분 업데이트, Priority Queue, Batch Reduction 적용 필수                     |

### NFR-004: 안정성

| 항목      | 기준                            |
| --------- | ------------------------------- |
| 에러 처리 | 조정 불가 시 명확한 에러 메시지 |
| 순환 감지 | 무한 루프 방지 (100회 제한)     |

---

## 4. 비즈니스 로직

### 4.1 조정 알고리즘 (v1.1)

```
1. 사용자 알고리즘 선택 (비례/금액순/역순)
2. 급부별 초과 여부 검사
3. 초과 발견 시 선택된 전략으로 감액:
   - [비례]: 기여도 비율대로 분배
   - [Global Greedy]: 위반수($V$) > 효율($E$) > 금액($A$) 순으로 점수 산정 후 배치 감액
   - [역순]: 리스트 뒤쪽(최신)부터 삭감
4. 감액 후 가입단위(Unit) 정합성 맞춤 (올림/내림)
5. 모든 제약 만족까지 반복
```

### 4.2 핵심 수식

```
Final_Amount = Current_Amount - Reduction_Amount

WHERE:
  Reduction_Amount = MIN(Excess, Current_Amount - Min_Amount)
  Reduction_Amount = CEIL(Reduction_Amount / Unit) × Unit
```

### 4.3 우선순위 정책

| 1 | **잠금(Lock)** | 사용자 잠금 제외 |
| 2 | **$V$ (위반수)** | 다중 위반 동시 해결 (최우선) |
| 3 | **$E$ (효율)** | 단위 감액 효율 극대화 |
| 4 | **$A$ (금액)** | 동일 조건 시 금액 큰 특약 우선 |
| 5 | **최대 위반 우선** | 화면 표시 시 가장 큰 초과분부터 강조 |

---

## 5. 에러 코드

| 코드               | 메시지                 | 발생 조건            |
| ------------------ | ---------------------- | -------------------- |
| `ERR_UNSOLVABLE`   | 조정 불가능한 제약     | 최소값으로도 초과    |
| `ERR_CIRCULAR`     | 순환 의존성 감지       | 100회 반복 후 미수렴 |
| `ERR_INVALID_UNIT` | 유효하지 않은 가입단위 | unit ≤ 0             |
| `ERR_NO_RIDERS`    | 특약 없음              | 빈 입력              |

---

## 6. 테스트 케이스

| TC-ID  | 시나리오       | 입력                                              | 예상 결과                  |
| ------ | -------------- | ------------------------------------------------- | -------------------------- |
| TC-001 | 단일 급부 초과 | 암 5천만(CI)+뇌 3천만(CI)+심 3천만(CI), CI 캡 1억 | 암 4천만으로 감액          |
| TC-002 | 정상 상태      | 모든 급부 캡 이내                                 | 변경 없음                  |
| TC-003 | 최소값 도달    | 암 1천만(min), 급부 초과                          | 경고 + 다음 특약 감액      |
| TC-004 | 다중 급부      | 암(CI+암급부) 8천만, 두 급부 초과                 | 두 급부 모두 만족까지 감액 |
| TC-005 | 가입단위 다름  | 암 단위 1천만, 뇌 단위 5백만                      | 단위 맞춰 조정             |
| TC-006 | 조정 불가      | 모든 특약 최소값인데 초과                         | ERR_UNSOLVABLE 반환        |
| TC-007 | 신암진단 복합  | 외암 기계약 3천 + 신암 설계 3천 (한도 5천)        | 신암진단 1천 감액          |

---

## 7. 변경 이력

| 버전 | 일자       | 작성자           | 변경 내용 |
| ---- | ---------- | ---------------- | --------- |
| 1.0  | 2026-01-27 | Strategy Planner | 초안      |

---

**문서 끝**
